services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_SUPERUSER:?POSTGRES_SUPERUSER is required}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD:?POSTGRES_SUPERUSER_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DEFAULT_DB:-postgres}
      ACCOUNTS_DB_NAME: ${ACCOUNTS_DB_NAME:-accounts}
      ACCOUNTS_DB_USER: ${ACCOUNTS_DB_USER:-accounts_user}
      ACCOUNTS_DB_PASSWORD: ${ACCOUNTS_DB_PASSWORD:?ACCOUNTS_DB_PASSWORD is required}
      SUBSCRIPTIONS_DB_NAME: ${SUBSCRIPTIONS_DB_NAME:-subscriptions}
      SUBSCRIPTIONS_DB_USER: ${SUBSCRIPTIONS_DB_USER:-subscriptions_user}
      SUBSCRIPTIONS_DB_PASSWORD: ${SUBSCRIPTIONS_DB_PASSWORD:?SUBSCRIPTIONS_DB_PASSWORD is required}
      PAYMENTS_DB_NAME: ${PAYMENTS_DB_NAME:-payments_xmr}
      PAYMENTS_DB_USER: ${PAYMENTS_DB_USER:-payments_xmr_user}
      PAYMENTS_DB_PASSWORD: ${PAYMENTS_DB_PASSWORD:?PAYMENTS_DB_PASSWORD is required}
      REPORTER_DB_NAME: ${REPORTER_DB_NAME:-reporter}
      REPORTER_DB_USER: ${REPORTER_DB_USER:-reporter_user}
      REPORTER_DB_PASSWORD: ${REPORTER_DB_PASSWORD:?REPORTER_DB_PASSWORD is required}
      NOTIFICATIONS_DB_NAME: ${NOTIFICATIONS_DB_NAME:-notifications}
      NOTIFICATIONS_DB_USER: ${NOTIFICATIONS_DB_USER:-notifications_user}
      NOTIFICATIONS_DB_PASSWORD: ${NOTIFICATIONS_DB_PASSWORD:?NOTIFICATIONS_DB_PASSWORD is required}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - novareport

  accounts-service:
    image: davidandreasson/novareport-accounts-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${ACCOUNTS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      JWT_ACCESS_TOKEN_MINUTES: ${JWT_ACCESS_TOKEN_MINUTES:-30}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${ACCOUNTS_DB_NAME:-accounts}
      DB_USER: ${ACCOUNTS_DB_USER:-accounts_user}
      DB_PASSWORD: ${ACCOUNTS_DB_PASSWORD}
    ports:
      - '18080:8080'
    networks:
      - novareport
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  subscriptions-service:
    image: davidandreasson/novareport-subscriptions-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${SUBSCRIPTIONS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBS_FAKE_ALL_ACTIVE: ${SUBS_FAKE_ALL_ACTIVE:-false}
      JWT_ACCESS_TOKEN_MINUTES: ${JWT_ACCESS_TOKEN_MINUTES:-30}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${SUBSCRIPTIONS_DB_NAME:-subscriptions}
      DB_USER: ${SUBSCRIPTIONS_DB_USER:-subscriptions_user}
      DB_PASSWORD: ${SUBSCRIPTIONS_DB_PASSWORD}
    ports:
      - '18081:8080'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payments-xmr-service:
    image: davidandreasson/novareport-payments-xmr-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${PAYMENTS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBSCRIPTIONS_BASE_URL: ${SUBSCRIPTIONS_BASE_URL:-http://subscriptions-service:8080}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${PAYMENTS_DB_NAME:-payments_xmr}
      DB_USER: ${PAYMENTS_DB_USER:-payments_xmr_user}
      DB_PASSWORD: ${PAYMENTS_DB_PASSWORD}
    ports:
      - '18084:8084'
    networks:
      - novareport
    depends_on:
      - subscriptions-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  notifications-service:
    image: davidandreasson/novareport-notifications-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${NOTIFICATIONS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      JWT_ACCESS_TOKEN_MINUTES: ${JWT_ACCESS_TOKEN_MINUTES:-30}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${NOTIFICATIONS_DB_NAME:-notifications}
      DB_USER: ${NOTIFICATIONS_DB_USER:-notifications_user}
      DB_PASSWORD: ${NOTIFICATIONS_DB_PASSWORD}
    ports:
      - '18083:8083'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  reporter-service:
    image: davidandreasson/novareport-reporter-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${REPORTER_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBS_BASE_URL: ${SUBS_BASE_URL:-http://subscriptions-service:8080}
      NOTIF_BASE_URL: ${NOTIF_BASE_URL:-http://notifications-service:8083}
      RSS_FEEDS: ${RSS_FEEDS:-https://cointelegraph.com/rss}
      REPORTER_FAKE_AI: ${REPORTER_FAKE_AI:-false}
      REPORTER_DEDUP_WINDOW_HOURS: ${REPORTER_DEDUP_WINDOW_HOURS:-48}
      ONEMIN_API_KEY: ${ONEMIN_API_KEY:-}
      ONEMIN_MODEL: ${ONEMIN_MODEL:-gpt-4o-mini}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${REPORTER_DB_NAME:-reporter}
      DB_USER: ${REPORTER_DB_USER:-reporter_user}
      DB_PASSWORD: ${REPORTER_DB_PASSWORD}
    ports:
      - '18082:8080'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - subscriptions-service
      - notifications-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    image: davidandreasson/novareport-frontend:${TAG:-latest}
    environment:
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
    ports:
      - '15173:80'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - subscriptions-service
      - payments-xmr-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  novareport:
    driver: bridge

volumes:
  postgres-data:

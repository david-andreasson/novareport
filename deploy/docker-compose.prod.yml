services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_SUPERUSER:?POSTGRES_SUPERUSER is required}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD:?POSTGRES_SUPERUSER_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DEFAULT_DB:-postgres}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - novareport

  accounts-service:
    image: davidandreasson/novareport-accounts-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${ACCOUNTS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      JWT_ACCESS_TOKEN_MINUTES: ${JWT_ACCESS_TOKEN_MINUTES:-30}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${ACCOUNTS_DB_NAME:-accounts}
      DB_USER: ${ACCOUNTS_DB_USER:-accounts_user}
      DB_PASSWORD: ${ACCOUNTS_DB_PASSWORD}
    ports:
      - '18080:8080'
    networks:
      - novareport
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payments-stripe-service:
    image: davidandreasson/novareport-payments-stripe-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${PAYMENTS_STRIPE_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBSCRIPTIONS_BASE_URL: ${SUBSCRIPTIONS_BASE_URL:-http://subscriptions-service:8080}
      NOTIFICATIONS_BASE_URL: ${NOTIFICATIONS_BASE_URL:-http://notifications-service:8080}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${PAYMENTS_STRIPE_DB_NAME:-payments_stripe}
      DB_USER: ${PAYMENTS_STRIPE_DB_USER:-payments_stripe_user}
      DB_PASSWORD: ${PAYMENTS_STRIPE_DB_PASSWORD}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
    ports:
      - '18085:8085'
    networks:
      - novareport
    depends_on:
      - subscriptions-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  subscriptions-service:
    image: davidandreasson/novareport-subscriptions-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${SUBSCRIPTIONS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBS_FAKE_ALL_ACTIVE: ${SUBS_FAKE_ALL_ACTIVE:-false}
      JWT_ACCESS_TOKEN_MINUTES: ${JWT_ACCESS_TOKEN_MINUTES:-30}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${SUBSCRIPTIONS_DB_NAME:-subscriptions}
      DB_USER: ${SUBSCRIPTIONS_DB_USER:-subscriptions_user}
      DB_PASSWORD: ${SUBSCRIPTIONS_DB_PASSWORD}
    ports:
      - '18081:8080'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payments-xmr-service:
    image: davidandreasson/novareport-payments-xmr-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${PAYMENTS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBSCRIPTIONS_BASE_URL: ${SUBSCRIPTIONS_BASE_URL:-http://subscriptions-service:8080}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${PAYMENTS_DB_NAME:-payments_xmr}
      DB_USER: ${PAYMENTS_DB_USER:-payments_xmr_user}
      DB_PASSWORD: ${PAYMENTS_DB_PASSWORD}
      MONERO_WALLET_RPC_URL: http://monero-wallet-rpc:18082/json_rpc
      MONERO_MIN_CONFIRMATIONS: ${MONERO_MIN_CONFIRMATIONS:-1}
    ports:
      - '18084:8084'
    networks:
      - novareport
    depends_on:
      - subscriptions-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  monero-wallet-rpc:
    image: sethsimmons/simple-monero-wallet-rpc:latest
    command: >
      --stagenet
      --rpc-bind-port=18082
      --daemon-address=${MONERO_DAEMON_ADDRESS}
      --wallet-file=/home/monero/${MONERO_WALLET_NAME}
      --password=${MONERO_WALLET_PASSWORD}
      --disable-rpc-login
    volumes:
      - monero-wallet-data:/home/monero
    networks:
      - novareport

  notifications-service:
    image: davidandreasson/novareport-notifications-service:${TAG:-latest}
    environment:
      SPRING_PROFILES_ACTIVE: ${NOTIFICATIONS_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      JWT_ACCESS_TOKEN_MINUTES: ${JWT_ACCESS_TOKEN_MINUTES:-30}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${NOTIFICATIONS_DB_NAME:-notifications}
      DB_USER: ${NOTIFICATIONS_DB_USER:-notifications_user}
      DB_PASSWORD: ${NOTIFICATIONS_DB_PASSWORD}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_SMTP_AUTH: ${MAIL_SMTP_AUTH:-true}
      MAIL_SMTP_STARTTLS: ${MAIL_SMTP_STARTTLS:-true}
      NOTIFICATIONS_MAIL_FROM: ${NOTIFICATIONS_MAIL_FROM}
      NOTIFICATIONS_EMAIL_CRON: ${NOTIFICATIONS_EMAIL_CRON:-0 0 6 * * *}
      NOTIFICATIONS_REPORT_ZONE: ${NOTIFICATIONS_REPORT_ZONE:-Europe/Stockholm}
      NOTIFICATIONS_DISCORD_ENABLED: ${NOTIFICATIONS_DISCORD_ENABLED:-false}
      NOTIFICATIONS_DISCORD_WEBHOOK_URL: ${NOTIFICATIONS_DISCORD_WEBHOOK_URL:-}
      NOTIFICATIONS_DISCORD_CRON: ${NOTIFICATIONS_DISCORD_CRON:-0 5 6 * * *}
      NOTIFICATIONS_DISCORD_INVITE_URL: ${NOTIFICATIONS_DISCORD_INVITE_URL:-}
    ports:
      - '18083:8080'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  reporter-service:
    image: davidandreasson/novareport-reporter-service:${TAG:-latest}
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      SPRING_PROFILES_ACTIVE: ${REPORTER_PROFILE:-prod}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-accounts-service}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      SUBS_BASE_URL: ${SUBS_BASE_URL:-http://subscriptions-service:8080}
      NOTIF_BASE_URL: ${NOTIF_BASE_URL:-http://notifications-service:8080}
      RSS_FEEDS: ${RSS_FEEDS:-https://cointelegraph.com/rss,https://decrypt.co/feed,https://www.coindesk.com/arc/outboundfeeds/rss/?outputType=xml,https://www.reddit.com/r/CryptoCurrency/.rss}
      REPORTER_FAKE_AI: ${REPORTER_FAKE_AI:-false}
      REPORTER_DEDUP_WINDOW_HOURS: ${REPORTER_DEDUP_WINDOW_HOURS:-48}
      REPORTER_STARTUP_GENERATE_REPORT: "true"
      ONEMIN_API_KEY: ${ONEMIN_API_KEY:-}
      ONEMIN_MODEL: ${ONEMIN_MODEL:-gpt-4o-mini}
      NEWSAPI_ENABLED: ${NEWSAPI_ENABLED:-false}
      NEWSAPI_MAX_RESULTS: ${NEWSAPI_MAX_RESULTS:-20}
      NEWSAPI_NEWSDATA_ENABLED: ${NEWSAPI_NEWSDATA_ENABLED:-false}
      NEWSAPI_NEWSDATA_BASE_URL: ${NEWSAPI_NEWSDATA_BASE_URL:-https://newsdata.io/api/1}
      NEWSAPI_NEWSDATA_API_KEY: ${NEWSAPI_NEWSDATA_API_KEY:-}
      NEWSAPI_NEWSDATA_TIMEFRAME_HOURS: ${NEWSAPI_NEWSDATA_TIMEFRAME_HOURS:-24}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${REPORTER_DB_NAME:-reporter}
      DB_USER: ${REPORTER_DB_USER:-reporter_user}
      DB_PASSWORD: ${REPORTER_DB_PASSWORD}
    ports:
      - '18082:8080'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - subscriptions-service
      - notifications-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    image: davidandreasson/novareport-frontend:${TAG:-latest}
    environment:
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
    ports:
      - '15173:80'
    networks:
      - novareport
    depends_on:
      - accounts-service
      - subscriptions-service
      - payments-xmr-service
      - payments-stripe-service
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  novareport:
    driver: bridge

volumes:
  postgres-data:
  monero-wallet-data:
